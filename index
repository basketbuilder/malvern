<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProQuote - Optical Dispensing</title>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #27ae60; --light: #f8fafc; --dark: #1e293b; 
            --border: #e2e8f0; --error: #ef4444; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f1f5f9; color: var(--primary); margin: 0; padding: 10px; line-height: 1.5; }
        .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) {
            .container { grid-template-columns: 1fr 400px; padding: 20px; }
            .summary-sticky { position: sticky; top: 20px; height: fit-content; }
        }
        .card { background: white; padding: 16px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid var(--border); }
        h2 { font-size: 1.1rem; margin-top: 0; color: var(--dark); border-left: 4px solid var(--accent); padding-left: 10px; }
        .group-title { font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin: 15px 0 8px 0; border-bottom: 1px solid #f1f5f9; font-weight: 800; letter-spacing: 0.05em; }
        .sub-group-title { font-size: 0.8rem; color: var(--accent); margin: 8px 0 4px 0; font-weight: bold; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; background: #e2e8f0; padding: 4px; border-radius: 12px; }
        .tab { flex: 1; padding: 12px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; font-size: 0.9rem; transition: 0.2s; background: transparent; color: #64748b; }
        .tab.active { background: white; color: var(--accent); shadow: var(--shadow); }
        .tab.locked { opacity: 0.5; cursor: not-allowed; }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-bottom: 10px; }
        .option-card { border: 1px solid var(--border); padding: 12px 8px; border-radius: 12px; cursor: pointer; background: white; text-align: center; font-size: 0.85rem; display: flex; flex-direction: column; justify-content: center; min-height: 60px; }
        .option-card.selected { border-color: var(--accent); background: #f0fdf4; box-shadow: 0 0 0 1px var(--accent); }
        .option-card.disabled { background: #f8fafc; color: #cbd5e1; cursor: not-allowed; opacity: 0.6; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 800; padding-top: 15px; margin-top: 10px; color: var(--dark); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 8px; }
        .btn-print { background: #3b82f6; color: white; }
        .btn-dark { background: var(--dark); color: white; }
        .btn-supp { background: #f1f5f9; color: var(--primary); border: 1px solid var(--border); margin: 0; font-size: 0.75rem; padding: 8px; }
        .btn-supp.active { background: var(--accent); color: white; border-color: var(--accent); }
        .validation-msg { color: var(--error); background: #fef2f2; border: 1px solid #fee2e2; padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; text-align: center; }
        .savings-badge { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 10px; border-radius: 10px; margin: 10px 0; font-weight: bold; font-size: 0.85rem; text-align: center; }
        .voucher-badge { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 8px; border-radius: 8px; font-size: 0.8rem; margin-top: 5px; }
        @media print { .no-print, .main, .tabs, .btn, .btn-supp, .input-field::placeholder { display: none !important; } body { background: white; padding: 0; } .container { display: block; } .card { box-shadow: none; border: 1px solid #eee; margin: 0; padding: 20px; } .input-field { border: none; font-weight: bold; font-size: 1.2rem; padding: 0; margin-bottom: 20px; } textarea { border: none !important; resize: none; overflow: visible; } }
    </style>
</head>
<body>

<div class="container">
    <div class="main no-print">
        <div class="tabs">
            <button id="tab0" class="tab active" onclick="switchPair(0)">Pair One</button>
            <button id="tab1" class="tab locked" onclick="switchPair(1)">Pair Two</button>
        </div>

        <div class="card">
            <h2>1. Frame Price</h2>
            <div class="selection-grid" id="frame-list"></div>
        </div>
        
        <div class="card">
            <h2>2. Lenses</h2>
            <div class="group-title">Single Vision & Boost</div>
            <div class="selection-grid" id="lens-sv"></div>
            
            <div class="group-title">Varifocal</div>
            <div class="sub-group-title">Specialist</div>
            <div class="selection-grid" id="lens-var-spec"></div>
            <div class="sub-group-title">Core</div>
            <div class="selection-grid" id="lens-var-core"></div>

            <div class="group-title">Occupational / Bifocal</div>
            <div class="selection-grid" id="lens-mixed"></div>
        </div>

        <div class="card">
            <h2>3. Treatments & Thinning</h2>
            <div class="group-title">Anti-Reflective & UV</div>
            <div class="selection-grid" id="treat-main"></div>
            <div class="group-title">Thinning Options</div>
            <div class="selection-grid" id="treat-thin"></div>
        </div>
    </div>

    <div class="summary-sticky">
        <div class="card">
            <div id="timestamp-display" style="font-size:0.7rem; color:#94a3b8; text-align:right; margin-bottom:8px;"></div>
            <input type="text" id="cust-name" class="input-field" placeholder="Customer Name">
            
            <div id="validation-box"></div>

            <div class="no-print">
                <p style="font-size:0.75rem; font-weight:bold; margin-bottom:5px;">Offers</p>
                <select id="offer-selector" onchange="renderAll()" class="input-field">
                    <option value="none">No Offer</option>
                    <option value="unlimited">NHS Unlimited Choice</option>
                    <option value="unlimitedplus">NHS Unlimited Choice+</option>
                    <option value="2for1">2 for 1 Offer</option>
                    <option value="reglaze2for1">2 for 1 Reglaze Offer</option>
                    <option value="goldenticket">Golden Ticket (50%)</option>
                    <option value="discount40">¬£40 Off Upgrades</option>
                    <option value="student">Student Discount (25%)</option>
                    <option value="over60">Over 60s (20%)</option>
                </select>
                
                <p style="font-size:0.75rem; font-weight:bold; margin: 10px 0 5px 0;">Vouchers & Supplements</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
                    <select id="voucher-0" onchange="renderAll()" class="input-field" style="margin:0;"></select>
                    <select id="voucher-1" onchange="renderAll()" class="input-field" style="margin:0;"></select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
                    <button id="supp-complex" class="btn btn-supp" onclick="toggleSupp('complex')">Complex</button>
                    <button id="supp-tint" class="btn btn-supp" onclick="toggleSupp('tint')">Tint</button>
                    <button id="supp-prism" class="btn btn-supp" onclick="toggleSupp('prism')">Prism</button>
                </div>
            </div>
            
            <div id="basket-details" style="margin-top:15px;"></div>
            <div id="savings-box"></div>
            <div class="total-row"><span>Total</span><span id="grand-total">¬£0.00</span></div>
            <textarea id="dispensing-notes" class="input-field" style="margin-top:15px; height:80px;" placeholder="Dispensing Notes..."></textarea>
            <button id="print-btn" class="btn btn-print no-print" onclick="window.print()">üìÑ Save as PDF / Print</button>
            <button class="btn btn-dark no-print" style="background:#64748b" onclick="resetAll()">Clear All</button>
        </div>
    </div>
</div>

<script>
    const gosVouchers = [
        {name: "No Voucher", val: 0}, {name: "A (¬£42.40)", val: 42.40}, {name: "B (¬£64.26)", val: 64.26},
        {name: "C (¬£94.14)", val: 94.14}, {name: "D (¬£212.40)", val: 212.40}, {name: "E (¬£73.10)", val: 73.10},
        {name: "F (¬£92.72)", val: 92.72}, {name: "G (¬£120.48)", val: 120.48}, {name: "H (¬£233.56)", val: 233.56}
    ];

    const data = {
        frames: [
            {name:"¬£15",price:15}, {name:"¬£30",price:30}, {name:"¬£50",price:50}, 
            {name:"¬£70",price:70}, {name:"¬£90",price:90}, {name:"¬£100",price:100}, 
            {name:"¬£130",price:130}, {name:"¬£150",price:150}, {name:"¬£170",price:170}, 
            {name:"¬£170 Rimless",price:170}, {name:"¬£40 Reglaze", price:40}
        ],
        lenses: [
            {name:"Standard Single Vision", price:0, cat:"sv", type:"std"},
            {name:"SuperSingle Vision", price:65, cat:"sv", type:"super"},
            {name:"SuperBoost", price:65, cat:"sv", type:"super"},
            {name:"SuperDigital Varifocal", price:220, cat:"var-spec", type:"super"},
            {name:"SuperDrive Varifocal", price:220, cat:"var-spec", type:"super"},
            {name:"Tailormade Varifocal", price:180, cat:"var-core", type:"std"},
            {name:"Elite Varifocal", price:140, cat:"var-core", type:"std"},
            {name:"Premium Varifocal", price:90, cat:"var-core", type:"std"},
            {name:"Standard Varifocal", price:40, cat:"var-core", type:"std"},
            {name:"SuperReader 1/2/3", price:135, cat:"mixed", type:"super"},
            {name:"Premium Occupational", price:80, cat:"mixed", type:"std"},
            {name:"Premium Bifocal", price:60, cat:"mixed", type:"std"},
            {name:"Standard Bifocal", price:50, cat:"mixed", type:"std"}
        ],
        treatments: [
            {name:"UltraClear SuperClean", price:40, cat:"main"},
            {name:"Reactions (Brn/Gry)", price:70, cat:"main"},
            {name:"Polarised (Brn/Grn/Gry)", price:70, cat:"main"},
            {name:"Mirror Tint (Incl UCSC)", price:60, cat:"main"},
            {name:"Tint & UV Protection", price:30, cat:"main"},
            {name:"UV400 Protection (Clear)", price:15, cat:"main"},
            {name:"UltraDrive (Day/Night)", price:30, cat:"main"},
            {name:"Ultimate Thin (1.74)", price:140, cat:"thin"},
            {name:"Super Thin (1.67)", price:100, cat:"thin"},
            {name:"Extra Thin (1.6)", price:60, cat:"thin"},
            {name:"Aspheric Lenses (1.5)", price:25, cat:"thin"}
        ]
    };

    let pairs = [{ frame: null, lens: null, upgrades: [] }, { frame: null, lens: null, upgrades: [] }];
    let activeIdx = 0;
    let supplements = { complex: 0, tint: 0, prism: 0 };

    function populateVouchers() {
        const v0 = document.getElementById('voucher-0'), v1 = document.getElementById('voucher-1');
        gosVouchers.forEach(v => { const opt = `<option value="${v.val}">${v.name}</option>`; v0.innerHTML += opt; v1.innerHTML += opt; });
    }

    function toggleSupp(type) {
        const vals = { complex: 39.10, tint: 4.60, prism: 13.10 };
        supplements[type] = supplements[type] === 0 ? vals[type] : 0;
        document.getElementById(`supp-${type}`).classList.toggle('active', supplements[type] > 0);
        renderAll();
    }

    function checkConflicts(name, type, p) {
        if (!p || !p.lens) return false;
        const selNames = p.upgrades.map(u => u.name);
        const isBifocal = p.lens.name.includes("Bifocal");
        const isPremiumBifocal = p.lens.name === "Premium Bifocal";
        const isMixed = p.lens.cat === 'mixed';
        const isSuper = p.lens.type === 'super';
        const highThinSelected = p.upgrades.some(u => ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(u.name));

        if (name === "Aspheric Lenses (1.5)") {
            if (p.lens.name !== "Standard Single Vision") return true;
            if (selNames.some(n => ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)", "Polarised (Brn/Grn/Gry)", "Reactions (Brn/Gry)"].includes(n))) return true;
        }
        
        if (isPremiumBifocal) {
            if (["Reactions (Brn/Gry)", "Polarised (Brn/Grn/Gry)", "Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)", "Aspheric Lenses (1.5)"].includes(name)) return true;
        }
        if (isBifocal && !isPremiumBifocal) {
            if (["Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(name)) return true;
            const bifocalConflictGroup = ["Extra Thin (1.6)", "Reactions (Brn/Gry)", "Polarised (Brn/Grn/Gry)"];
            if (bifocalConflictGroup.includes(name)) return selNames.some(n => bifocalConflictGroup.includes(n) && n !== name);
        }

        if ((name === "Mirror Tint (Incl UCSC)" || name === "UltraDrive (Day/Night)") && (isMixed || isBifocal)) return true;
        if (name === "UltraClear SuperClean" && (isSuper || highThinSelected)) return true;

        const tintGroup = ["Reactions (Brn/Gry)", "Polarised (Brn/Grn/Gry)", "Mirror Tint (Incl UCSC)"];
        const highThinGroup = ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"];

        if (selNames.includes("Ultimate Thin (1.74)") && tintGroup.includes(name)) return true;
        if (name === "Ultimate Thin (1.74)" && selNames.some(n => tintGroup.includes(n))) return true;

        if (name === "UV400 Protection (Clear)") {
            if (selNames.some(n => tintGroup.includes(n) || highThinGroup.includes(n))) return true;
        }
        if (highThinGroup.includes(name) && selNames.includes("UV400 Protection (Clear)")) return true;

        const uvGroup = [...tintGroup, "Tint & UV Protection", "UltraDrive (Day/Night)", "UV400 Protection (Clear)"];
        if (uvGroup.includes(name)) {
            const currentUV = selNames.filter(n => uvGroup.includes(n));
            if (name === "Polarised (Brn/Grn/Gry)") return currentUV.some(n => !["Mirror Tint (Incl UCSC)", "Polarised (Brn/Grn/Gry)"].includes(n));
            if (name === "Mirror Tint (Incl UCSC)") return currentUV.some(n => !["Polarised (Brn/Grn/Gry)", "Mirror Tint (Incl UCSC)"].includes(n));
            if (currentUV.length > 0 && !currentUV.includes(name)) return true;
        }
        return false;
    }

    function handleSelection(type, name, cat) {
        let p = pairs[activeIdx];
        if(type === 'frame') p.frame = p.frame?.name === name ? null : {...data.frames.find(f => f.name === name)};
        else if(type === 'lens') p.lens = p.lens?.name === name ? null : {...data.lenses.find(l => l.name === name)};
        else if(type === 'upgrade') {
            let idx = p.upgrades.findIndex(u => u.name === name);
            if(idx > -1) p.upgrades.splice(idx, 1);
            else {
                if(cat === 'thin') p.upgrades = p.upgrades.filter(u => u.cat !== 'thin');
                p.upgrades.push({...data.treatments.find(t => t.name === name)});
            }
        }
        p.upgrades = p.upgrades.filter(u => !checkConflicts(u.name, 'upgrade', p));
        renderAll();
    }

    function calculate() {
        let runningTotal = 0, totalSavings = 0;
        const offer = document.getElementById('offer-selector').value;
        const vVal = (parseFloat(document.getElementById('voucher-0').value)||0) + (parseFloat(document.getElementById('voucher-1').value)||0) + supplements.complex + supplements.tint + supplements.prism;

        const isReglaze2for1 = (offer === 'reglaze2for1' && pairs[0].frame?.name === "¬£40 Reglaze" && pairs[1].frame?.name === "¬£40 Reglaze");
        const isStandard2for1 = (offer === '2for1' && pairs[0].frame?.price >= 70);

        let costs = pairs.map((p, i) => {
            if(!p.frame || !p.lens) return { f:0, l:0, u:0, total:0, isSuper:false };
            let uP = 0;
            const hasHighThin = p.upgrades.some(u => ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(u.name));
            p.upgrades.forEach(u => {
                let c = u.price;
                if(p.frame.name.includes("Rimless") && u.cat === 'thin' && u.name !== "Aspheric Lenses (1.5)") c -= 60;
                else if(p.lens.type === 'super' && u.cat === 'thin' && u.name !== "Aspheric Lenses (1.5)") c -= 40;
                if(u.name === "Tint & UV Protection" && hasHighThin) c -= 15;
                uP += c;
            });

            let fPrice = p.frame.price;
            if (isReglaze2for1) fPrice = (i === 0) ? 40 : 30; // Specific P1/P2 split requested
            
            return { f: fPrice, l: p.lens.price, u: uP, total: fPrice+p.lens.price+uP, isSuper: p.lens.type==='super' };
        });

        if ((isStandard2for1 || isReglaze2for1) && pairs[1].lens && pairs[1].frame) {
            // Frame logic
            let frameSaving = 0;
            if (isStandard2for1) {
                frameSaving = Math.min(costs[0].f, costs[1].f);
            } else if (isReglaze2for1) {
                frameSaving = 10; // 40+40 reduced to 40+30
            }

            // Lens logic
            let lensSaving = 0;
            const pairToDiscount = costs[0].l <= costs[1].l ? 0 : 1;
            if (pairs[pairToDiscount].lens.type === 'super') {
                lensSaving = Math.max(0, costs[pairToDiscount].l - 40);
            } else {
                lensSaving = costs[pairToDiscount].l;
            }

            totalSavings = frameSaving + lensSaving;
            runningTotal = (costs[0].total + costs[1].total) - totalSavings;
        } else {
            pairs.forEach((p, i) => {
                if(!p.frame || !p.lens) return;
                let net = costs[i].total;
                const offerValid = (offer === 'none' || offer === 'unlimited' || (pairs[0].frame?.price >= 70) || (offer==='reglaze2for1' && pairs[0].frame?.name === "¬£40 Reglaze"));
                
                if(offerValid && i === 0) {
                    if(offer==='unlimited') { net -= Math.min(costs[i].f, 50); totalSavings += Math.min(costs[i].f, 50); if(p.lens.name.includes("Standard Varifocal")){net-=40; totalSavings+=40;}}
                    else if(offer==='unlimitedplus') { net -= (50 + Math.min(40, costs[i].l+costs[i].u)); totalSavings += (50 + Math.min(40, costs[i].l+costs[i].u)); }
                    else if(offer==='goldenticket') { totalSavings += net*0.5; net *= 0.5; }
                    else if(offer==='discount40') { let d = Math.min(40, costs[i].l+costs[i].u); net -= d; totalSavings += d; }
                    else if(offer==='student') { totalSavings += net*0.25; net *= 0.75; }
                    else if(offer==='over60') { totalSavings += net*0.2; net *= 0.8; }
                }
                runningTotal += net;
            });
            // General Reglaze flat rate logic (no 2for1 lens discount)
            const generalBothReglaze = (pairs[0].frame?.name === "¬£40 Reglaze" && pairs[1].frame?.name === "¬£40 Reglaze" && offer !== 'reglaze2for1');
            if(generalBothReglaze) { runningTotal -= 10; totalSavings += 10; }
        }
        return { total: Math.max(0, runningTotal - vVal), savings: totalSavings, vTotal: vVal, offerDenied: (offer!=='none' && offer!=='unlimited' && offer!=='reglaze2for1' && (pairs[0].frame?.price || 0) < 70) };
    }

    function renderGrids() {
        const p = pairs[activeIdx], isSuper = p.lens?.type === 'super', rim = p.frame?.name.includes("Rimless");
        const render = (id, items, type) => {
            let h = '';
            items.forEach(i => {
                let pr = i.price;
                if(rim && i.cat==='thin' && i.name !== "Aspheric Lenses (1.5)") pr -= 60;
                else if(isSuper && i.cat==='thin' && i.name !== "Aspheric Lenses (1.5)") pr -= 40;
                if(i.name === "Tint & UV Protection" && p.upgrades.some(u => ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(u.name))) pr = 15;
                const sel = (type==='upgrade' ? p.upgrades.some(u=>u.name===i.name) : (p[type]?.name===i.name));
                const dis = checkConflicts(i.name, type, p);
                let dName = (type==='frame' && !i.name.includes('Reglaze') && !i.name.includes('Rimless')) ? "<strong>"+i.name+"</strong>" : (i.name+"<br><strong>¬£"+Math.max(0, pr)+"</strong>");
                h += `<div class="option-card ${sel?'selected':''} ${dis?'disabled':''}" onclick="handleSelection('${type}','${i.name}','${i.cat}')">${dName}</div>`;
            });
            document.getElementById(id).innerHTML = h;
        };
        render('frame-list', data.frames, 'frame');
        render('lens-sv', data.lenses.filter(l=>l.cat==='sv'), 'lens');
        render('lens-var-spec', data.lenses.filter(l=>l.cat==='var-spec'), 'lens');
        render('lens-var-core', data.lenses.filter(l=>l.cat==='var-core'), 'lens');
        render('lens-mixed', data.lenses.filter(l=>l.cat==='mixed'), 'lens');
        render('treat-main', data.treatments.filter(t=>t.cat==='main'), 'upgrade');
        render('treat-thin', data.treatments.filter(t=>t.cat==='thin'), 'upgrade');
    }

    function renderAll() {
        const res = calculate(); const p = pairs[activeIdx];
        renderGrids();
        document.getElementById('tab1').classList.toggle('locked', !pairs[0].lens);
        let msg = '';
        if(!p.frame || !p.lens) msg = `‚ö†Ô∏è Selection incomplete`;
        else if (p.frame?.name.includes("Rimless") && !p.upgrades.some(u => ["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(u.name))) msg = `‚ö†Ô∏è Rimless requires 1.6+ Thinning`;
        else if (res.offerDenied) msg = `‚ÑπÔ∏è Offer requires ¬£70+ Frame`;
        document.getElementById('validation-box').innerHTML = msg ? `<div class="validation-msg">${msg}</div>` : '';

        const offer = document.getElementById('offer-selector').value;
        const reglazeOfferActive = (offer === 'reglaze2for1' && pairs[0].frame?.name === "¬£40 Reglaze" && pairs[1].frame?.name === "¬£40 Reglaze");

        let h = ''; pairs.forEach((p, i) => {
            if(!p.frame || !p.lens) return;
            let displayFramePrice = p.frame.price;
            
            if (reglazeOfferActive) {
                displayFramePrice = (i === 0) ? 40 : 30;
            } else if (pairs[0].frame?.name === "¬£40 Reglaze" && pairs[1].frame?.name === "¬£40 Reglaze") {
                displayFramePrice = 35; // Visual split for flat rate if no 2for1 offer selected
            }

            h += `<div style="font-weight:800; border-bottom:1px solid #eee; margin-top:10px; color:#1e293b;">PAIR ${i+1}</div>`;
            h += `<div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-top:4px;"><span>${p.frame.name}</span><span>¬£${displayFramePrice}</span></div>`;
            h += `<div style="display:flex; justify-content:space-between; font-size:0.85rem;"><span>${p.lens.name}</span><span>¬£${p.lens.price}</span></div>`;
            p.upgrades.forEach(u => {
                let up = u.price;
                if(p.frame.name.includes('Rimless') && u.cat==='thin' && u.name!=='Aspheric Lenses (1.5)') up-=60;
                else if(p.lens.type==='super' && u.cat==='thin' && u.name!=='Aspheric Lenses (1.5)') up-=40;
                if(u.name.includes('Tint') && p.upgrades.some(ut=>["Extra Thin (1.6)", "Super Thin (1.67)", "Ultimate Thin (1.74)"].includes(ut.name))) up=15;
                h += `<div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#64748b;"><span>+ ${u.name}</span><span>¬£${Math.max(0, up)}</span></div>`;
            });
        });
        document.getElementById('basket-details').innerHTML = h;
        document.getElementById('grand-total').innerText = `¬£${res.total.toFixed(2)}`;
        document.getElementById('savings-box').innerHTML = (res.savings > 0 ? `<div class="savings-badge">Total Savings: -¬£${res.savings.toFixed(2)}</div>` : '') + (res.vTotal > 0 ? `<div class="voucher-badge">Vouchers & Supps: -¬£${res.vTotal.toFixed(2)}</div>` : '');
    }
    function switchPair(i) { if(i===1 && !pairs[0].lens) return; activeIdx = i; document.querySelectorAll('.tab').forEach((t,x)=>t.classList.toggle('active',x===i)); renderAll(); }
    function resetAll() { if(confirm("Clear everything?")) location.reload(); }
    populateVouchers(); renderAll();
    document.getElementById('timestamp-display').innerText = new Date().toLocaleString([], {dateStyle:'short', timeStyle:'short'});
</script>
</body>
</html>
